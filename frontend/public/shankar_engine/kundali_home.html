<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Kundali Chart - Nirvana Astro</title>
  <link rel="icon" type="image/x-icon" href="img/logo.png" />
  <link rel="stylesheet" href="css/index.css" />
  <script src="ephemeris/index.js"></script>
  <script src="ephemeris/common.js"></script>
  <script src="ephemeris/load.js"></script>
  <script src="ephemeris/astronomy/index.js"></script>
  <script src="ephemeris/astronomy/moshier/index.js"></script>
  <script src="ephemeris/astronomy/moshier/constant.js"></script>
  <script src="ephemeris/astronomy/moshier/julian.js"></script>
  <script src="ephemeris/astronomy/moshier/delta.js"></script>
  <script src="ephemeris/astronomy/moshier/epsilon.js"></script>
  <script src="ephemeris/astronomy/moshier/lonlat.js"></script>
  <script src="ephemeris/astronomy/moshier/gplan.js"></script>
  <script src="ephemeris/astronomy/moshier/precess.js"></script>
  <script src="ephemeris/astronomy/moshier/util.js"></script>
  <script src="ephemeris/astronomy/moshier/kepler.js"></script>
  <script src="ephemeris/astronomy/moshier/body.js"></script>
  <script src="ephemeris/astronomy/moshier/sun.js"></script>
  <script src="ephemeris/astronomy/moshier/aberration.js"></script>
  <script src="ephemeris/astronomy/moshier/altaz.js"></script>
  <script src="ephemeris/astronomy/moshier/constellation.js"></script>
  <script src="ephemeris/astronomy/moshier/deflection.js"></script>
  <script src="ephemeris/astronomy/moshier/diurnal.js"></script>
  <script src="ephemeris/astronomy/moshier/fk4fk5.js"></script>
  <script src="ephemeris/astronomy/moshier/light.js"></script>
  <script src="ephemeris/astronomy/moshier/moon.js"></script>
  <script src="ephemeris/astronomy/moshier/nutation.js"></script>
  <script src="ephemeris/astronomy/moshier/planet.js"></script>
  <script src="ephemeris/astronomy/moshier/refraction.js"></script>
  <script src="ephemeris/astronomy/moshier/siderial.js"></script>
  <script src="ephemeris/astronomy/moshier/star.js"></script>
  <script src="ephemeris/astronomy/moshier/transit.js"></script>
  <script src="ephemeris/astronomy/moshier/vearth.js"></script>
  <script src="ephemeris/astronomy/moshier/processor.js"></script>
  <script src="ephemeris/astronomy/moshier/plan404/index.js"></script>
  <script src="ephemeris/astronomy/moshier/plan404/mercury.js"></script>
  <script src="ephemeris/astronomy/moshier/plan404/venus.js"></script>
  <script src="ephemeris/astronomy/moshier/plan404/earth.js"></script>
  <script src="ephemeris/astronomy/moshier/plan404/moonlr.js"></script>
  <script src="ephemeris/astronomy/moshier/plan404/moonlat.js"></script>
  <script src="ephemeris/astronomy/moshier/plan404/mars.js"></script>
  <script src="ephemeris/astronomy/moshier/plan404/jupiter.js"></script>
  <script src="ephemeris/astronomy/moshier/plan404/saturn.js"></script>
  <script src="ephemeris/shortcut.js"></script>
  <script src="sjp.js"></script>
  <script src="jyotish.js"></script>
  <script src="kcd.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    html,
    body {
      background: transparent !important;
      color: #eee;
      font-family: 'Segoe UI', 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      min-width: 100vw;
    }

    .astro-title {
      font-size: 2.2em;
      text-align: center;
      margin: 32px 0 18px 0;
      color: #219150;
      font-weight: bold;
      letter-spacing: 0.5px;
      text-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
    }

    .astro-title .cosmos-emoji {
      font-size: 1.3em;
      margin: 0 0.2em;
    }

    /* Embedded Style Overrides - Cleanup */
    .astro-details-card,
    #flag-fab,
    #flag-popup,
    a[href="SJP.html"],
    .goog-te-banner-frame.skiptranslate,
    .goog-te-gadget-simple,
    iframe.goog-te-banner-frame,
    .VIpgJd-ZVi9od-ORHb-OEVmcd {
      display: none !important;
    }

    body {
      top: 0px !important;
    }

    /* Ensure full width usage since sidebar is gone */
    /* --- Full Legacy Report Styling Overrides --- */
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif !important;
      line-height: 1.6;
      color: #e2e8f0 !important;
      /* Slate-200 */
      background: transparent !important;
    }

    a {
      color: #a855f7 !important;
      /* Purple-500 */
      text-decoration: none;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px dashed rgba(168, 85, 247, 0.4);
      padding-bottom: 1px;
      transition: all 0.2s;
    }

    a:hover {
      color: #d8b4fe !important;
      /* Purple-300 */
      border-bottom-style: solid;
    }

    b,
    strong {
      color: #94a3b8 !important;
      /* Slate-400 */
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.1em;
      margin-right: 6px;
    }

    /* Container for the text dump */
    #kundali-output {
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 1.05em;
      width: 100%;
      padding-bottom: 50px;
    }

    /* Attempt to target the blocks of text if they are in divs, otherwise style global text */
    div {
      margin-bottom: 0px;
      break-inside: avoid;
    }

    /* Target specific "Headers" in the text dump if they use unique styling */
    font[color="blue"] {
      display: block;
      margin-top: 12px;
      margin-bottom: 6px;
      color: #be85ff !important;
      /* Lighter Purple */
      font-weight: 900;
      font-size: 1.1em;
      border-bottom: 2px solid rgba(168, 85, 247, 0.3);
      padding-bottom: 4px;
      break-after: avoid;
    }

    /* Make the whole report area look like a card content */
    .astro-chart-container {
      width: 100%;
      background: transparent !important;
      border: none;
      box-shadow: none;
      margin: 0 !important;
      padding: 0 !important;
    }

    /* Tables Styling */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 8px 0;
      background: rgba(255, 255, 255, 0.03) !important;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
      break-inside: avoid;
    }

    th,
    td {
      padding: 10px 14px;
      border: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #cbd5e1 !important;
      font-size: 1em;
      text-align: left;
    }

    th {
      background: rgba(168, 85, 247, 0.25) !important;
      color: #e9d5ff !important;
      font-weight: 800;
      text-transform: uppercase;
      font-size: 0.75em;
      letter-spacing: 0.15em;
      border-bottom: 2px solid rgba(168, 85, 247, 0.3);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:nth-child(even) td {
      background: rgba(255, 255, 255, 0.02);
    }

    .cosmos-banner,
    .section-title {
      text-align: center;
      font-size: 1.25em;
      margin: 28px 0 12px 0;
      color: #219150;
      font-weight: bold;
      letter-spacing: 1px;
      text-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
    }

    .cosmos-banner .cosmos-emoji,
    .section-title .cosmos-emoji {
      font-size: 1.3em;
      margin: 0 0.2em;
    }

    .astro-chart-container input[type="submit"],
    .astro-chart-container button[type="button"] {
      background: #2ecc40;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 24px;
      font-weight: bold;
      font-size: 1.1em;
      cursor: pointer;
      box-shadow: 0 2px 8px #b2dfdb44;
      margin-top: 8px;
      transition: background 0.2s;
    }

    .astro-chart-container input[type="submit"]:hover,
    .astro-chart-container button[type="button"]:hover {
      background: #219150;
    }

    @media (max-width: 950px) {
      .astro-chart-container {
        max-width: 98vw;
        padding: 18px 2vw 18px 2vw;
      }

      .astro-title {
        font-size: 1.3em;
      }

      th,
      td {
        font-size: 0.98em;
        padding: 7px 4px;
      }
    }

    @media (max-width: 600px) {
      .astro-chart-container {
        max-width: 100vw;
        min-width: 100vw;
        border-radius: 0;
        padding: 8px 2vw 18px 2vw;
        min-height: 100vh;
        max-height: 932px;
      }

      .astro-title {
        font-size: 1.1em;
      }

      th,
      td {
        font-size: 0.98em;
        padding: 7px 4px;
      }
    }

    .astro-chart-container>*:not(:last-child) {
      margin-bottom: 8px;
    }

    .ad-left,
    .ad-right {
      position: fixed;
      top: 0;
      width: 260px;
      height: 100vh;
      background: #fffbe7;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-size: 1.1em;
      color: #bfa600;
      font-weight: bold;
      letter-spacing: 1px;
      border-right: 2px solid #ffe066;
      pointer-events: auto;
      padding-top: 32px;
      gap: 18px;
      box-shadow: 2px 0 16px #ffe06644;
    }

    .ad-left {
      left: 0;
      border-radius: 0 60px 60px 0;
      border-right: 2px solid #ffe066;
    }

    .ad-right {
      right: 0;
      border-radius: 60px 0 0 60px;
      border-left: 2px solid #ffe066;
    }

    .ad-section {
      width: 220px;
      min-height: 120px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 12px #ffe06644;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 12px 10px 10px 10px;
      border: 1.5px solid #ffe066;
      text-align: center;
      transition: box-shadow 0.2s;
    }

    .ad-section img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 8px;
      box-shadow: 0 1px 6px #ffe06633;
    }

    .ad-section-title {
      font-size: 1.08em;
      color: #bfa600;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .ad-section-desc {
      font-size: 0.98em;
      color: #888;
      font-weight: normal;
    }

    @media (max-width: 1400px) {
      .astro-chart-container {
        margin-left: 140px;
        margin-right: 140px;
      }

      .ad-left,
      .ad-right {
        width: 120px;
      }

      .ad-section {
        width: 100px;
        min-height: 80px;
        padding: 8px 4px 8px 4px;
      }

      .ad-section img {
        width: 48px;
        height: 48px;
      }
    }

    @media (max-width: 1200px) {

      .ad-left,
      .ad-right {
        width: 60px;
        font-size: 0.9em;
      }

      .ad-section {
        width: 60px;
        min-height: 40px;
        padding: 4px 2px 4px 2px;
      }

      .ad-section img {
        width: 28px;
        height: 28px;
      }
    }

    @media (max-width: 950px) {

      .ad-left,
      .ad-right {
        display: none;
      }

      .astro-chart-container {
        margin-left: 0 !important;
        margin-right: 0 !important;
      }
    }

    .astro-chart-container {
      margin: 0 !important;
      width: 100%;
    }
  </style>
</head>

<body>
  <!-- Ads removed -->
  <!-- Title removed -->
  <script>
    (function () {
      // Immediate cookie setup for Google Translate
      // This runs before the widget loads to force the language natively
      try {
        const params = {};
        window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (str, key, value) {
          params[key] = decodeURIComponent(value);
        });

        const lang = params.lang || 'en';
        // Format: /source/target e.g. /en/ne
        const cookieVal = lang === 'ne' ? '/en/ne' : '/en/en';

        document.cookie = `googtrans=${cookieVal}; path=/; SameSite=Lax`;
        document.cookie = `googtrans=${cookieVal}; path=/; domain=${window.location.hostname}; SameSite=Lax`;
      } catch (e) { console.error(e); }
    })();
  </script>
  <div class="astro-chart-container" id="kundali-output"></div>
  <!-- Floating Flag Button -->
  <div id="flag-fab"
    style="position:fixed;bottom:24px;right:24px;z-index:9999;cursor:pointer;background:#fff;border-radius:50%;box-shadow:0 2px 8px #8884;width:56px;height:56px;display:flex;align-items:center;justify-content:center;">
    <img src="https://cdn.jsdelivr.net/npm/flag-icons/flags/4x3/gb.svg" alt="Translate" style="width:32px;height:32px;"
      id="flag-current">
  </div>
  <!-- Language Popup -->
  <div id="flag-popup"
    style="display:none;position:fixed;bottom:90px;right:24px;z-index:10000;background:#fff;border-radius:12px;box-shadow:0 2px 16px #8888;padding:18px 18px 10px 18px;min-width:220px;">
    <div style="font-weight:bold;margin-bottom:10px;">Translate</div>
    <div id="google_translate_element"></div>
    <div style="font-size:0.95em;color:#888;margin-top:8px;">Select language above</div>
  </div>
  <script type="text/javascript"
    src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  <script>
    // Parse query params
    function getQueryParams() {
      const params = {};
      window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (str, key, value) {
        params[key] = decodeURIComponent(value);
      });
      return params;
    }

    // --- DYNAMIC ADS LOGIC ---
    const defaultAds = [
      {
        title: 'Learn Vedic Astrology',
        desc: 'Free open-source resources for beginners.',
        img: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=400&q=80',
        url: ''
      },
      {
        title: 'Zodiac Signs Explained',
        desc: 'Discover your Rashi and Nakshatra.',
        img: 'https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=400&q=80',
        url: ''
      },
      {
        title: 'Constellation Guide',
        desc: 'Explore the night sky with open data.',
        img: 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29?auto=format&fit=crop&w=400&q=80',
        url: ''
      },
      {
        title: 'Open Source Astro Tools',
        desc: 'Try free astrology calculation software.',
        img: 'https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=400&q=80',
        url: ''
      },
      {
        title: 'Daily Horoscope',
        desc: 'Get your free daily predictions online.',
        img: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=400&q=80',
        url: ''
      },
      {
        title: 'Birth Chart Generator',
        desc: 'Create your Janma Kundali instantly.',
        img: 'https://images.unsplash.com/photo-1465101178521-c1a9136a3b99?auto=format&fit=crop&w=400&q=80',
        url: ''
      },
      {
        title: 'Astrology Community',
        desc: 'Join open forums and discussions.',
        img: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=400&q=80',
        url: ''
      },
      {
        title: 'Open Astro Data',
        desc: 'Access free datasets for research.',
        img: 'https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=400&q=80',
        url: ''
      }
    ];

    function getAds() {
      const saved = localStorage.getItem('astro_ads');
      if (saved) {
        try {
          const arr = JSON.parse(saved);
          if (Array.isArray(arr) && arr.length === 8) return arr;
        } catch { }
      }
      return defaultAds;
    }

    function renderAdAreas() {
      const ads = getAds();
      const left = document.getElementById('ad-left');
      const right = document.getElementById('ad-right');
      if (!left || !right) return;
      left.innerHTML = '';
      right.innerHTML = '';
      for (let i = 0; i < 4; ++i) {
        const ad = ads[i];
        const div = document.createElement('div');
        div.className = 'ad-section';
        div.innerHTML = `
          <img src="${ad.img}" alt="${ad.title}" style="cursor:pointer;">
          <div class="ad-section-title">${ad.title}</div>
          <div class="ad-section-desc">${ad.desc}</div>
        `;
        div.querySelector('img').onclick = function () {
          if (ad.url) window.open(ad.url, '_blank');
        };
        left.appendChild(div);
      }
      for (let i = 4; i < 8; ++i) {
        const ad = ads[i];
        const div = document.createElement('div');
        div.className = 'ad-section';
        div.innerHTML = `
          <img src="${ad.img}" alt="${ad.title}" style="cursor:pointer;">
          <div class="ad-section-title">${ad.title}</div>
          <div class="ad-section-desc">${ad.desc}</div>
        `;
        div.querySelector('img').onclick = function () {
          if (ad.url) window.open(ad.url, '_blank');
        };
        right.appendChild(div);
      }
    }
    // Ensure ads are rendered after DOM is ready (for navigation from ads.html)
    document.addEventListener('DOMContentLoaded', renderAdAreas);
    window.onload = function () {
      renderAdAreas();
      // Read params from sessionStorage 
      let sessionParams = {};
      try {
        sessionParams = JSON.parse(sessionStorage.getItem('kundali_form_data') || '{}');
      } catch (e) { sessionParams = {}; }

      // Merge with query params, query params (like lang) should take priority
      const queryParams = getQueryParams();
      window.params = { ...sessionParams, ...queryParams };
      if (typeof doForm === 'function') {
        // Hijack document.write in doForm to render to #kundali-output
        const originalWrite = document.write;
        document.write = function (html) {
          const out = document.getElementById('kundali-output');
          if (out) {
            out.innerHTML = html;
            // Force script execution
            const spts = out.querySelectorAll('script');
            spts.forEach(oldS => {
              const newS = document.createElement('script');
              Array.from(oldS.attributes).forEach(a => newS.setAttribute(a.name, a.value));
              if (oldS.src) {
                newS.src = oldS.src;
              } else {
                newS.appendChild(document.createTextNode(oldS.innerHTML));
              }
              oldS.parentNode.replaceChild(newS, oldS);
            });
          }
        };
        doForm();
        document.write = originalWrite;
      } else {
        document.getElementById('kundali-output').innerHTML = '<b>Error:</b> Chart logic not loaded.';
      }
    };
    // Google Translate Widget
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'en,ne,hi,fi',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
        autoDisplay: false
      }, 'google_translate_element');

      // Dynamic Language Switching
      // Dynamic Language Switching with Polling
      let attempts = 0;
      const maxAttempts = 20; // Try for 10 seconds (20 * 500ms)

      const pollTranslate = setInterval(function () {
        // Fallback to getQueryParams if window.params isn't ready
        let p = window.params;
        if (!p) {
          const q = {};
          window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (str, key, value) {
            q[key] = decodeURIComponent(value);
          });
          p = q;
        }
        const targetLang = (p && p.lang) ? p.lang : 'en';
        const select = document.querySelector('select.goog-te-combo');

        attempts++;
        if (attempts > maxAttempts) {
          clearInterval(pollTranslate);
          return;
        }

        if (select) {
          if (targetLang === 'ne' && select.value !== 'ne') {
            select.value = 'ne';
            select.dispatchEvent(new Event('change'));
            clearInterval(pollTranslate); // Success
          } else if (targetLang === 'en') {
            // For English, we ensure it's selected or just stop if already 'en'
            if (select.value !== 'en') {
              select.value = 'en';
              select.dispatchEvent(new Event('change'));
            }
            clearInterval(pollTranslate); // Success
          }
        }
      }, 500);
    }
    // Floating flag button logic
    const flagFab = document.getElementById('flag-fab');
    const flagPopup = document.getElementById('flag-popup');
    const flagCurrent = document.getElementById('flag-current');
    flagFab.onclick = function () {
      flagPopup.style.display = flagPopup.style.display === 'none' ? 'block' : 'none';
    };
    document.addEventListener('click', function (e) {
      if (!flagFab.contains(e.target) && !flagPopup.contains(e.target)) {
        flagPopup.style.display = 'none';
      }
    });
  </script>
</body>

</html>